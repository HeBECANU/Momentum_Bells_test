lambda1 = [4.2e-3,1.5e-3,6e-3].*4.*[0.25;1;0.5;1.5;2;0.3;0.2;0.8;3;2.5;0.25;0.65]; % with [4.2e-3,1.5e-3,6e-3].*4.*lambda;%

E_val1 = [5.252231614736754e-01    -4.241183260679152e-01     3.228521154255179e-01
         3.551224426684130e-01    -1.968412364236541e-01     3.532256106444180e-01
         5.302450022711862e-01    -3.971577599355985e-01     3.225750080231968e-01
         2.551532517593879e-01    -2.074060547241271e-01     1.885519344413464e-01
         9.375083158084697e-02    -6.694440419154528e-02     6.286391299637036e-02
         6.091006153592262e-01    -2.557041090460373e-01     4.159781257387904e-01
         4.382142170574467e-01    -1.000000000000000e+00     1.694407676253286e-01
         3.941678202114490e-01    -2.269730919303386e-01     3.493446724885422e-01
         7.958670093074567e-02    -3.708647879800318e-02     3.890327151365761e-02
         9.290446566142312e-02    -4.930666435229479e-02     4.498155988308696e-02
         5.182545149949572e-01    -4.050238388848863e-01     3.720522685097652e-01
         4.938215134916808e-01    -3.038570601978838e-01     3.546194067527714e-01
         ];

E_unc1 = [3.022258925212176e-01     3.951012728902753e-01     3.673675928302976e-01
         8.345541062491273e-02     1.130070231700727e-01     9.340314647516339e-02
         1.220413037352232e-01     1.844172753263029e-01     1.322528391285886e-01
         8.139517747614047e-02     8.628176660249523e-02     7.295099734459255e-02
         4.687720147460263e-02     5.934955426254562e-02     4.765398691368623e-02
         2.235675090787804e-01     3.313479770795634e-01     2.051572773971026e-01
         3.347706723149342e-01     6.978375356275786e-01     3.296253572316371e-01
         9.032275157485986e-02     1.104893231657813e-01     1.043362089570836e-01
         4.382766269200172e-02     5.279743936319919e-02     4.669578900346203e-02
         4.793261336282498e-02     5.302853268777146e-02     4.432022248000984e-02
         2.180755271052502e-01     3.700171970895671e-01     3.061180847558073e-01
         1.208020532282189e-01     1.291324356896437e-01     1.276534672341811e-01
         ];

top_corr_bb_vec1 = [
     1.880696681767935e+01     3.825000966856170e+00     2.168478805709927e+01
     4.756055491680359e+00     1.706417727149287e+00     5.589280448038287e+00 
     1.361937847046946e+01     1.832335792505950e+00     1.151154328369846e+01
     2.790632864653014e+00     1.468547329271418e+00     2.792669718676617e+00
     1.704889578324934e+00     1.730775574417336e+00     1.866805254779550e+00
     2.143939393939394e+01     4.739475774424146e+00     1.554545454545455e+01
     2.134698275862069e+01                         0     2.078125000000000e+01
     6.009505190777942e+00     2.081477051876215e+00     6.044008610380292e+00
     1.710192610721747e+00     1.778212096493662e+00     1.667001562054530e+00
     1.719726104563362e+00     1.758973398020014e+00     1.713396567345559e+00
     2.696905940594059e+01     5.353970390309555e+00     2.023913043478261e+01
     9.303745450275919e+00     2.354775059194949e+00     8.195920101997450e+00
     ];
 
wt1 =[ nan nan nan
     6.203550641322206e-01     5.098721030806110e-01     7.017732028821534e-01
     2.281251604304220e+00     1.215586099561351e+00     2.247898029527236e+00
     4.386426729180297e-01     3.758718337908212e-01     3.764100616336065e-01
     1.432751875803895e-01     2.364539605531852e-01     1.709306620240940e-01
     6.074494949494949e+00     3.455591988182850e+00     4.750000000000000e+00
     1.065365497583826e+01                         0     1.156656760615066e+01
     9.002764088027067e-01     5.518046105963855e-01     9.976288242550996e-01
     1.266387633022699e-01     2.090034724556397e-01     1.949526484318261e-01
     1.657716128912286e-01     2.266636610940808e-01     1.665688032694508e-01
     8.418196598105771e+00     3.821060364955595e+00     9.396739130434781e+00
     1.744452271926735e+00     8.242559360151330e-01     1.644964927162202e+00
     ];
 
btm_corr_bb_vec1 = [
     2.075898732570195e+01     3.394198810179537e+00     1.064000267335004e+01
     5.835590182588406e+00     3.338649605984403e+00     4.124174134343577e+00
     1.050000267559483e+01     4.346592007791103e+00     6.591411347752643e+00
     3.512822906901979e+00     2.188986290241690e+00     2.730559347437491e+00
     2.169540579688486e+00     1.588666979785930e+00     1.821206647039843e+00
     1.387254901960784e+01     4.582949308755761e+00     1.019808306709265e+01
     2.201111111111111e+01                         0     1.102209944751381e+01
     6.963515151515153e+00     3.509126687928344e+00     4.347941332390882e+00
     1.990750888409283e+00     1.566703757066140e+00     1.734604457804529e+00
     2.078830971084064e+00     1.570656180987936e+00     1.758544380528084e+00
     1.904807692307692e+01     2.624010554089709e+00     8.382352941176471e+00
     8.814955502496201e+00     3.626033057851240e+00     5.834551911426781e+00
     ];
 
btw_1_corr_bb_vec = [
     5.966868990348066e+00     1.084909365144659e+01     1.299674593650249e+01
     2.699961747190207e+00     3.217676067984460e+00     2.084066941049567e+00
     3.277089337957912e+00     5.391573565898792e+00     3.480157873969704e+00
     1.825545189953311e+00     2.357229906449261e+00     1.835803396462465e+00
     1.571907857421850e+00     1.864468104820588e+00     1.594313784840649e+00
     2.827980014275517e+00     6.526661197703034e+00     6.031746031746031e+00
     8.052845528455284e+00     1.444794188861986e+01     1.773333333333333e+01
     2.893807557954907e+00     3.874775968206967e+00     2.120085015940488e+00
     1.578791569668163e+00     1.785353234212308e+00     1.564757653722104e+00
     1.565643815723938e+00     1.846976796234455e+00     1.568657876084558e+00
     4.596287703016241e+00     1.101939058171745e+01     1.041775456919060e+01
     2.712150598973189e+00     5.205371900826447e+00     2.464788732394366e+00
     ];
 
btw_2_corr_bb_vec = [
     6.349360592293454e+00     7.003522897060593e+00     3.549822955966428e+00
     2.340405363175356e+00     4.300320246892761e+00     2.558480174993758e+00
     4.127084384990745e+00     8.928817990181571e+00     5.792203860958909e+00
     1.915120364264847e+00     3.214511164598267e+00     1.935015035163077e+00
     1.638328887013678e+00     1.931297843267168e+00     1.657437450884712e+00
     5.750362844702468e+00     9.201233616037008e+00     4.586206896551725e+00
     8.883408071748880e+00     9.102974828375284e+00     4.854014598540146e+00
     2.743586361537954e+00     4.998809523809524e+00     2.890923461994467e+00
     1.576487772664731e+00     1.817220546363200e+00     1.582092016433171e+00
     1.587105823893175e+00     1.828027935651299e+00     1.604381491794137e+00
     1.000505050505051e+01     7.820445609436435e+00     2.681451612903226e+00
     3.427335640138408e+00     5.996521335807050e+00     4.219741480611046e+00
     ];
%%
lambda2 = [7.3e-3,1.2e-3,12.7e-3].*[1;2;3;1.5;2.5;3.5;5;6;8]./2; %opts_E.delta_kd = [7.3e-3,1.2e-3,12.7e-3].*lambda;%
E_val2 = [
     4.221389359923417e-01    -6.714856967087051e-01     2.867889979372620e-01
     5.460026033350356e-01    -3.131493653878484e-01     3.668022852357197e-01
     3.642167624390603e-01    -1.647665130567540e-01     2.758534908525990e-01
     4.730610752372597e-01    -4.654030596197867e-01     2.735890673178267e-01
     5.043514857886595e-01    -3.783031088483061e-01     3.908605226571524e-01
     4.384746418145450e-01    -2.787894604785981e-01     3.127476377251575e-01
     3.327495690519724e-01    -2.155596839180015e-01     3.465528710528692e-01
     3.159169715747234e-01    -2.169907440890028e-01     2.507308420087760e-01
     2.258556922406243e-01    -1.775498432844121e-01     1.594752395368005e-01
     ];
E_unc2 = [
     3.541709895081610e-01     4.963119937448939e-01     3.344873372333129e-01
     1.634522422481406e-01     1.908612367580744e-01     1.628182092832851e-01
     9.988242095719817e-02     1.154026721970010e-01     1.090376226383543e-01
     1.801711806381661e-01     3.581832292667489e-01     2.088152723550062e-01
     1.327781397727861e-01     1.832557939306110e-01     1.439664189357263e-01
     1.141148882085395e-01     1.335244409993794e-01     1.091357398036739e-01
     9.285937290030806e-02     9.756159021995035e-02     9.419838025475030e-02
     8.069203756699074e-02     9.519033034126304e-02     7.876290617426221e-02
     7.661977436820931e-02     8.555507946451142e-02     6.986605248315775e-02
     ];
top_corr_bb_vec = [
     1.380487804878049e+01                         0     2.073804573804573e+01
     1.385314685314685e+01     2.838387442026400e+00     1.152734976887519e+01
     6.256765187553615e+00     2.101426307448495e+00     5.645693802471464e+00
     1.710919185687847e+01     2.775994417306350e+00     1.528735632183908e+01
     1.180299827022872e+01     1.711335771133577e+00     1.019038774088693e+01
     7.402148528724895e+00     2.076633952808520e+00     6.190159574468085e+00
     4.137389330306470e+00     1.593430803124374e+00     4.886581469648562e+00
     3.562612399432087e+00     1.612513218188227e+00     3.880742181654945e+00
     ];
wt = [
     8.628048780487804e+00                         0     1.130294845889432e+01
     3.336379299543835e+00     1.323010415621502e+00     3.028035303616600e+00
     9.779548254257437e-01     5.564818909042566e-01     1.089714394510136e+00
     3.982676861850406e+00     2.775994417306350e+00     5.259574280950471e+00
     2.184085274563248e+00     1.069584856958486e+00     2.432060268005451e+00
     1.308195577459065e+00     7.925737980705304e-01     1.002315900681609e+00
     8.078362389754562e-01     4.979471259763669e-01     6.844180710333628e-01
     5.141779357630151e-01     4.655104603917554e-01     4.980104569259202e-01
     ];
btm_corr_bb_vec = [
     2.028327645051194e+01     3.877192982456140e+00     1.233384853168470e+01
     1.181980906921241e+01     3.924366984544558e+00     7.980000000000000e+00
     6.177311827956989e+00     2.969615043176499e+00     4.116998950682056e+00
     1.426890756302521e+01     2.634437086092715e+00     9.963928967813541e+00
     9.815607857016458e+00     3.863636363636364e+00     5.805374871619309e+00
     7.592567905349109e+00     2.983686480405025e+00     4.915407358738501e+00
     5.267792898482717e+00     3.045667447306792e+00     4.102178812922614e+00
     4.471660197649131e+00     2.590255058285424e+00     3.150698215671063e+00
     ];
btw_1_corr_bb_vec = [
     6.581395348837209e+00     1.227777777777778e+01     1.445652173913043e+01
     3.730696798493409e+00     5.103739002932551e+00     3.355196770938446e+00
     2.363697378724039e+00     2.802172332303217e+00     2.243440233236151e+00
     4.891358024691359e+00     5.634560906515580e+00     5.298804780876494e+00
     3.313940520446097e+00     5.347972215998207e+00     2.446351931330472e+00
     2.614376209748372e+00     3.872998701860667e+00     2.164841669132880e+00
     2.479556074766355e+00     2.986950442752835e+00     2.021276595744681e+00
     2.193414918414919e+00     2.755249343832021e+00     1.972553699284010e+00
     ];
btw_2_corr_bb_vec = [
     7.269724770642201e+00     7.449438202247190e+00     3.873786407766990e+00
     3.808394745273950e+00     7.825573770491804e+00     5.681962025316456e+00
     3.431113210518029e+00     4.269597710287804e+00     3.297650438820890e+00
     6.333120204603580e+00     9.196169088507267e+00     9.103650586701434e+00
     3.808882907133243e+00     7.011750881316099e+00     4.559131593982099e+00
     3.238986283949496e+00     5.099533009797637e+00     3.649167733674775e+00
     2.229214455745510e+00     4.201742804330605e+00     2.340735268555536e+00
     1.983223614355490e+00     3.776895778856929e+00     2.239736626513336e+00
     ];
%%
lambda = [lambda1;lambda2];
E_val = [E_val1;E_val2];
E_unc = [E_unc1;E_unc2];
l_lim= 8;
mdl = @(b,x) rob_E([x(:,1)./b(2),x(:,2)./b(3),x(:,3)./b(4)]',b(1),0)';
w = 1./E_unc(:,1).^2;
mdl_fit=fitnlm(1.*lambda,E_val(:,1),mdl,[10,1e-3,1e-3,1e-3],'Weight',w)
xp=linspace(0,l_lim,1000);
[ysamp_val,ysamp_ci]=predict(mdl_fit,xp','Prediction','curve','Alpha',1-erf(1/sqrt(2)));
stfig('E vs lambda');
clf
colors_main=[[88,113,219];[60,220,180]./1.75;[88,113,219]./1.7];
colors_main=colors_main./255;
errorbar(lambda,E_val(:,1),E_unc(:,1),'o','CapSize',0,'MarkerSize',5,'Color',colors_main(3,:),...
    'MarkerFaceColor',colors_main(2,:),'LineWidth',2.5)
% errorbar(lambda,E_val(:,1),E_unc(:,1),'kx')
hold on
plot(xp,ysamp_val,'r','LineWidth',1.5)
%     drawnow
%     yl=ylim*1.1;
plot(xp,ysamp_ci,'color',[1,1,1].*0.5)
xlim([0,l_lim])
xlabel('$\lambda$')
ylabel('E(0)')
set(gca,'FontWeight','bold')
set(gca,'TickLabelInterpreter','latex')
ax = gca;
ax.XAxis.TickLabelFormat= '\\textbf{%g}';
ax.YAxis.TickLabelFormat= '\\textbf{%g}';
font_size_global = 15;
set(gca,'fontsize',font_size_global)